#include "common.h"
#include "maps.h"
#include <string.h>

static int cookies_eaten = 0;
static int total_cookies = 0;

int map_stage1[MAP_HEIGHT][MAP_WIDTH] = {
    {1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1},
    {1,3,2,2,2,2,2,2,2,2,2,2,2,1,1,1,2,2,2,2,2,2,2,2,2,2,2,3,1},
    {1,2,1,1,1,1,2,1,1,1,1,1,2,1,1,1,2,1,1,1,1,1,2,1,1,1,1,2,1},
    {1,2,1,1,1,1,2,1,1,1,1,1,2,1,1,1,2,1,1,1,1,1,2,1,1,1,1,2,1},
    {1,2,1,1,1,1,2,1,1,1,1,1,2,1,1,1,2,1,1,1,1,1,2,1,1,1,1,2,1},
    {1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1},
    {1,2,1,1,1,1,2,1,1,2,1,1,1,1,1,1,1,1,1,2,1,1,2,1,1,1,1,2,1},
    {1,2,1,1,1,1,2,1,1,2,1,1,1,1,1,1,1,1,1,2,1,1,2,1,1,1,1,2,1},
    {1,2,2,2,2,2,2,1,1,2,2,2,2,1,1,1,2,2,2,2,1,1,2,2,2,2,2,2,1},
    {1,1,1,1,1,1,2,1,1,1,1,1,0,1,1,1,0,1,1,1,1,1,2,1,1,1,1,1,1},
    {9,9,9,9,9,1,2,1,1,1,1,1,0,1,1,1,0,1,1,1,1,1,2,1,9,9,9,9,9},
    {9,9,9,9,9,1,2,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,2,1,9,9,9,9,9},
    {9,9,9,9,9,1,2,1,1,0,1,1,1,1,4,1,1,1,1,0,1,1,2,1,9,9,9,9,9},
    {1,1,1,1,1,1,2,1,1,0,1,5,5,5,5,5,5,5,1,0,1,1,2,1,1,1,1,1,1},
    {6,0,0,0,0,0,2,0,0,0,1,5,5,5,5,5,5,5,1,0,0,0,2,0,0,0,0,0,6},
    {1,1,1,1,1,1,2,1,1,0,1,5,5,5,5,5,5,5,1,0,1,1,2,1,1,1,1,1,1},
    {9,9,9,9,9,1,2,1,1,0,1,1,1,1,1,1,1,1,1,0,1,1,2,1,9,9,9,9,9},
    {9,9,9,9,9,1,2,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,2,1,9,9,9,9,9},
    {9,9,9,9,9,1,2,1,1,0,1,1,1,1,1,1,1,1,1,0,1,1,2,1,9,9,9,9,9},
    {1,1,1,1,1,1,2,1,1,0,1,1,1,1,1,1,1,1,1,0,1,1,2,1,1,1,1,1,1},
    {1,2,2,2,2,2,2,2,2,2,2,2,2,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,1},
    {1,2,1,1,1,1,2,1,1,1,1,1,2,1,1,1,2,1,1,1,1,1,2,1,1,1,1,2,1},
    {1,2,1,1,1,1,2,1,1,1,1,1,2,1,1,1,2,1,1,1,1,1,2,1,1,1,1,2,1},
    {1,3,2,2,1,1,2,2,2,2,2,2,2,0,0,0,2,2,2,2,2,2,2,1,1,2,2,3,1},
    {1,1,1,2,1,1,2,1,1,2,1,1,1,1,1,1,1,1,1,2,1,1,2,1,1,2,1,1,1},
    {1,1,1,2,1,1,2,1,1,2,1,1,1,1,1,1,1,1,1,2,1,1,2,1,1,2,1,1,1},
    {1,2,2,2,2,2,2,1,1,2,2,2,2,1,1,1,2,2,2,2,1,1,2,2,2,2,2,2,1},
    {1,2,1,1,1,1,1,1,1,1,1,1,2,1,1,1,2,1,1,1,1,1,1,1,1,1,1,2,1},
    {1,2,1,1,1,1,1,1,1,1,1,1,2,1,1,1,2,1,1,1,1,1,1,1,1,1,1,2,1},
    {1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1},
    {1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1}
};


int map_stage2[MAP_HEIGHT][MAP_WIDTH] = {
    {1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1},
    {1,2,2,2,1,1,2,2,2,1,1,1,2,2,2,2,2,1,1,1,2,2,2,1,1,2,2,2,1},
    {1,2,1,1,1,1,2,1,2,2,2,2,2,1,1,1,2,2,2,2,2,1,2,1,1,1,1,2,1},
    {1,3,2,2,2,2,2,1,2,1,1,1,2,1,1,1,2,1,1,1,2,1,2,2,2,2,2,3,1},
    {1,2,1,1,1,1,2,1,2,2,2,2,2,1,1,1,2,2,2,2,2,1,2,1,1,1,1,2,1},
    {1,2,2,2,2,2,2,2,2,1,1,1,2,2,2,2,2,1,1,1,2,2,2,2,2,2,2,2,1},
    {1,1,1,1,1,1,2,1,2,2,2,2,2,1,1,1,2,2,2,2,2,1,2,1,1,1,1,1,1},
    {1,1,1,1,1,1,2,1,1,1,1,1,0,1,1,1,0,1,1,1,1,1,2,1,1,1,1,1,1},
    {1,1,1,1,1,1,2,1,2,2,2,2,2,2,2,2,2,2,2,2,2,1,2,1,1,1,1,1,1},
    {1,2,2,2,2,2,2,2,2,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,1},
    {1,2,1,1,1,1,1,1,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,1}, // exit_path (13,11) 확보
    {1,2,2,2,2,2,2,2,2,0,0,0,0,0,0,0,0,0,0,0,2,2,2,2,2,2,2,2,1}, // exit_path (13,12) 확보
    {1,1,1,1,1,1,1,1,1,0,1,1,1,1,4,1,1,1,1,0,1,1,1,1,1,1,1,1,1},
    {1,1,1,1,1,1,1,1,1,0,1,5,5,5,5,5,5,5,1,0,1,1,1,1,1,1,1,1,1},
    {6,2,2,2,2,2,2,2,2,0,1,5,5,5,5,5,5,5,1,0,2,2,2,2,2,2,2,2,6},
    {1,1,1,1,1,1,1,1,1,0,1,5,5,5,5,5,5,5,1,0,1,1,1,1,1,1,1,1,1},
    {1,1,1,1,1,1,2,2,2,0,1,1,1,1,1,1,1,1,1,0,2,2,2,1,1,1,1,1,1},
    {1,2,2,2,2,2,2,1,1,1,1,2,2,2,2,2,2,2,1,1,1,1,2,2,2,2,2,2,1},
    {1,2,1,1,1,1,2,1,2,2,2,2,1,1,1,1,1,2,2,2,2,1,2,1,1,1,1,2,1},
    {1,2,2,2,2,2,2,2,2,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,1},
    {1,1,1,1,1,1,2,1,2,2,2,2,2,2,2,2,2,2,2,2,2,1,2,1,1,1,1,1,1},
    {1,1,1,1,1,1,2,1,1,1,1,1,0,1,1,1,0,1,1,1,1,1,2,1,1,1,1,1,1},
    {1,1,1,1,1,1,2,1,2,2,2,2,2,1,1,1,2,2,2,2,2,1,2,1,1,1,1,1,1},
    {1,2,2,2,2,2,2,2,2,1,1,1,2,0,0,0,2,1,1,1,2,2,2,2,2,2,2,2,1}, // 팩맨 시작 위치 (13,23) 확보
    {1,2,1,1,1,1,2,1,2,2,2,2,2,1,1,1,2,2,2,2,2,1,2,1,1,1,1,2,1},
    {1,3,2,2,2,2,2,1,2,1,1,1,2,1,1,1,2,1,1,1,2,1,2,2,2,2,2,3,1},
    {1,2,1,1,1,1,2,1,2,2,2,2,2,1,1,1,2,2,2,2,2,1,2,1,1,1,1,2,1},
    {1,2,2,2,1,1,2,2,2,1,1,1,2,2,2,2,2,1,1,1,2,2,2,1,1,2,2,2,1},
    {1,1,1,2,1,1,1,2,1,1,1,1,1,2,1,2,1,1,1,1,1,2,1,1,1,2,1,1,1},
    {1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,1},
    {1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1}
};


int map_stage3[MAP_HEIGHT][MAP_WIDTH] = {
    {1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1},
    {1,3,2,2,2,1,2,2,2,2,1,2,2,2,2,2,2,2,1,2,2,2,2,1,2,2,2,3,1},
    {1,2,1,1,2,1,2,1,1,2,1,2,1,1,1,1,1,2,1,2,1,1,2,1,2,1,1,2,1},
    {1,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,1},
    {1,2,1,1,1,1,2,2,2,1,1,1,1,1,1,1,1,1,1,1,2,2,2,1,1,1,1,2,1},
    {1,2,2,2,2,1,2,1,1,1,2,2,2,2,2,2,2,2,2,1,1,1,2,1,2,2,2,2,1},
    {1,1,1,1,2,1,2,1,2,2,2,1,1,1,1,1,1,1,2,2,2,1,2,1,2,1,1,1,1},
    {1,2,2,2,2,2,2,2,2,1,2,2,2,2,2,2,2,2,2,1,2,2,2,2,2,2,2,2,1},
    {1,2,1,1,1,1,2,1,1,1,1,1,2,1,1,1,2,1,1,1,1,1,1,2,1,1,1,2,1},
    {1,2,2,2,2,1,2,2,2,2,2,2,2,1,1,1,2,2,2,2,2,2,2,2,1,2,2,2,1},
    {1,1,1,1,2,1,1,1,1,1,1,1,2,1,1,1,2,2,1,1,1,1,1,1,1,2,1,1,1}, // exit_path (13,11) 확보
    {6,2,2,2,2,2,2,2,2,2,0,0,0,0,0,0,0,0,0,2,2,2,2,2,2,2,2,2,6}, // exit_path (13,12) 확보
    {1,1,1,1,1,1,1,1,2,1,0,1,1,1,4,1,1,1,0,1,2,1,1,1,1,1,1,1,1},
    {1,9,9,9,9,9,9,1,2,2,0,1,5,5,5,5,5,1,0,2,2,1,9,9,9,9,9,9,1},
    {1,9,9,9,9,9,9,1,2,1,0,1,5,5,5,5,5,1,0,1,2,1,9,9,9,9,9,9,1},
    {1,9,9,9,9,9,9,1,2,2,0,1,5,5,5,5,5,1,0,2,2,1,9,9,9,9,9,9,1},
    {1,1,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1},
    {1,2,2,2,2,2,2,2,2,0,0,0,0,0,0,0,0,0,0,0,2,2,2,2,2,2,2,2,1},
    {1,2,1,1,2,1,1,1,1,1,0,1,1,1,1,1,1,1,0,1,1,1,1,2,1,1,2,1,1},
    {1,2,2,2,2,2,2,2,2,1,2,2,2,2,2,2,2,2,2,1,2,2,2,2,2,2,2,2,1},
    {1,1,1,1,2,1,2,1,2,2,2,1,1,1,1,1,1,1,2,2,2,1,2,1,2,1,1,1,1},
    {1,2,2,2,2,1,2,1,1,1,2,2,2,2,2,2,2,2,2,1,1,1,2,1,2,2,2,2,1},
    {1,2,1,1,1,1,2,2,2,2,2,1,1,1,1,1,1,1,2,2,2,2,2,1,1,1,1,2,1},
    {1,2,2,2,2,2,2,1,1,2,2,2,2,0,0,0,2,2,2,2,1,1,2,2,2,2,2,2,1}, // 팩맨 시작 위치 (13,23) 확보
    {1,2,1,1,2,1,2,1,1,2,1,2,1,1,1,1,1,2,1,2,1,1,2,1,2,1,1,2,1},
    {1,3,2,2,2,1,2,2,2,2,1,2,2,2,2,2,2,2,1,2,2,2,2,1,2,2,2,3,1},
    {1,2,1,1,1,1,2,1,2,2,2,2,2,1,1,1,2,2,2,2,2,1,2,1,1,1,1,2,1},
    {1,2,2,2,1,1,2,2,2,1,1,1,2,2,2,2,2,1,1,1,2,2,2,1,1,2,2,2,1},
    {1,1,1,2,1,1,1,2,1,1,1,1,1,2,1,2,1,1,1,1,1,2,1,1,1,2,1,1,1},
    {1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,1},
    {1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1}
};


int map_stage4[MAP_HEIGHT][MAP_WIDTH] = {
    {1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1},
    {1,3,2,2,2,1,1,2,2,2,2,2,2,1,1,1,2,2,2,2,2,2,1,1,2,2,2,3,1},
    {1,2,1,1,2,1,1,2,1,1,1,1,2,1,1,1,2,1,1,1,1,2,1,1,2,1,1,2,1},
    {1,2,1,1,2,2,2,2,1,1,2,2,2,2,2,2,2,2,2,1,1,2,2,2,2,1,1,2,1},
    {1,2,1,1,1,1,1,2,2,2,2,1,1,1,1,1,1,1,2,2,2,2,1,1,1,1,1,2,1},
    {1,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,1},
    {1,1,1,1,1,1,1,2,1,1,2,1,1,1,1,1,1,1,2,1,1,2,1,1,1,1,1,1,1},
    {1,1,1,1,1,1,1,2,1,1,2,2,2,2,2,2,2,2,2,1,1,2,1,1,1,1,1,1,1},
    {1,1,1,1,1,1,1,2,1,1,2,1,1,1,1,1,1,1,2,1,1,2,1,1,1,1,1,1,1},
    {1,2,2,2,2,2,2,2,2,2,2,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,1},
    {1,2,1,1,1,1,1,1,1,1,2,0,0,0,0,0,0,0,2,1,1,1,1,1,1,1,1,2,1}, // exit_path (13,11) 확보
    {1,2,2,2,2,2,2,2,2,0,0,0,0,0,0,0,0,0,0,0,2,2,2,2,2,2,2,2,1}, // exit_path (13,12) 확보
    {1,0,0,1,1,2,1,1,1,0,1,1,1,1,4,1,1,1,1,0,1,1,2,1,1,0,0,0,1},
    {1,1,1,1,1,2,1,1,1,0,1,1,5,5,5,5,5,1,1,0,1,1,2,1,1,1,1,1,1},
    {6,2,2,2,2,2,2,2,0,0,1,1,5,5,5,5,5,1,1,0,0,2,2,2,2,2,2,2,6},
    {1,1,1,1,1,1,1,1,1,0,1,1,5,5,5,5,5,1,1,0,1,1,2,1,1,1,1,1,1},
    {1,0,0,1,1,2,1,1,1,0,1,1,1,1,1,1,1,1,1,0,1,1,2,1,1,0,0,0,1},
    {1,2,2,2,2,2,2,2,2,0,1,1,1,1,1,1,1,1,1,0,2,2,2,2,2,2,2,2,1},
    {1,2,1,1,1,1,1,1,2,1,2,2,2,2,2,2,2,2,2,2,1,1,1,1,1,1,1,2,1},
    {1,2,2,2,2,2,2,2,2,2,2,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,1},
    {1,1,1,1,1,1,1,2,1,1,2,1,1,1,1,1,1,1,2,1,1,2,1,1,1,1,1,1,1},
    {1,1,1,1,1,1,1,2,1,1,2,2,2,2,2,2,2,2,2,1,1,2,1,1,1,1,1,1,1},
    {1,1,1,1,1,1,1,2,1,1,2,1,1,1,1,1,1,1,2,1,1,2,1,1,1,1,1,1,1},
    {1,2,2,2,2,2,2,2,1,1,2,2,2,0,0,0,2,2,2,1,1,2,2,2,2,2,2,2,1}, // 팩맨 시작 위치 (13,23) 확보
    {1,2,1,1,1,1,1,2,2,2,2,1,1,1,1,1,1,1,2,2,2,2,1,1,1,1,1,2,1},
    {1,2,1,1,2,2,2,2,1,1,2,2,2,2,2,2,2,2,2,1,1,2,2,2,2,1,1,2,1},
    {1,2,1,1,2,1,1,2,1,1,1,1,2,1,1,1,2,1,1,1,1,2,1,1,2,1,1,2,1},
    {1,3,2,2,2,1,1,2,2,2,2,2,2,1,1,1,2,2,2,2,2,2,1,1,2,2,2,3,1},
    {1,2,1,1,2,1,1,2,1,1,1,2,2,2,2,2,2,1,1,1,1,2,1,1,2,1,1,2,1},
    {1,2,2,2,2,2,2,2,2,2,2,2,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,1},
    {1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1}
};


int current_map[MAP_HEIGHT][MAP_WIDTH];

// 맵 배열 포인터
const int (*all_maps[])[MAP_WIDTH] = {
    map_stage1,
    map_stage2,
    map_stage3,
    map_stage4
};

// 최대 스테이지 수
const int MAX_STAGES = sizeof(all_maps) / sizeof(all_maps[0]);

// 오렌지 고스트 스테이지별 도망 위치
const Position orange_ghost_escape_positions[] = {
    {1, 29}, // stage 1
    {1, 27}, // stage 2
    {1, 27}, // stage 3
    {1, 29}  // stage 4
};

// === 함수 구현 ===

void initializeMaps(void) {
    // 필요시 맵 초기화 로직 (현재는 정적 배열이므로 불필요)
    debug_log("Maps initialized. Total stages: %d\n", MAX_STAGES);
}

void restoreMap(const int source_map[MAP_HEIGHT][MAP_WIDTH]) {
    if (!source_map) {
        debug_log("ERROR: Null source map provided to restoreMap\n");
        return;
    }
    
    // 외부 변수 current_map에 복사
    memcpy(current_map, source_map, sizeof(int) * MAP_HEIGHT * MAP_WIDTH);
    
    debug_log("Map restored successfully\n");
}

int getCurrentMapRemainingCookies(void) {
    return getMapCookieCount(current_map);
}

int getMapCookieCount(const int map[MAP_HEIGHT][MAP_WIDTH]) {
    int total = 0;
    
    for(int y = 0; y < MAP_HEIGHT; y++) {
        for(int x = 0; x < MAP_WIDTH; x++) {
            if(map[y][x] == COOKIE || map[y][x] == POWER_COOKIE) {
                total++;
            }
        }
    }
    
    return total;
}

int getCurrentMapTileAt(int x, int y) {
    if (x < 0 || x >= MAP_WIDTH || y < 0 || y >= MAP_HEIGHT) {
        debug_log("ERROR: Invalid coordinates (%d, %d) requested for map tile\n", x, y);
        return -1;  // Invalid coordinates
    }
    return current_map[y][x];
}

void setCurrentMapTileAt(int x, int y, int new_tile) {
    if (x < 0 || x >= MAP_WIDTH || y < 0 || y >= MAP_HEIGHT) {
        debug_log("ERROR: Invalid coordinates (%d, %d) for updating map tile\n", x, y);
        return;  // Invalid coordinates
    }
    current_map[y][x] = new_tile;
    return;  // Success
}

// 쿠키 관련
int getCookiesEaten(void){
    return cookies_eaten;
}
void eatCookie(void){
    cookies_eaten++;
}
void resetCookiesEaten(void){
    cookies_eaten = 0;
}
void resetTotalCookies(void){
    total_cookies = 0;
}
int getTotalCookies(void){
    return total_cookies;
}
void setTotalCookies(int count){
    total_cookies = count;
}

// 오렌지 고스트 도망 위치
Position getOrangeGhostEscapePosition(int stage) {
    if (stage < 0 || stage > MAX_STAGES) {
        debug_log("ERROR: Invalid stage %d for orange ghost escape position\n", stage);
        return (Position){-1, -1}; // Invalid position
    }
    return orange_ghost_escape_positions[stage - 1];
}





